# Interrupts

This document summarizes the interrupt handlers implemented in `Core/Src/stm32g4xx_it.c`.
The vector table that assigns each handler to a slot is defined in
`Core/Startup/startup_stm32g474retx.s`. Refer to that file for the exact
handler names and priority ordering.

## System Handlers

These handlers service core exceptions generated by the Cortex‑M4:

- **`NMI_Handler`** – non‑maskable interrupt.
- **`HardFault_Handler`** – hard fault exception.
- **`MemManage_Handler`** – memory management fault.
- **`BusFault_Handler`** – prefetch or memory access fault.
- **`UsageFault_Handler`** – undefined instruction or illegal state.
- **`SVC_Handler`** – system service call.
- **`DebugMon_Handler`** – debug monitor.
- **`PendSV_Handler`** – pendable request for system service.
- **`SysTick_Handler`** – system tick timer increments the HAL tick.

## Peripheral Handlers

The remaining handlers serve specific peripherals as noted in
`stm32g4xx_it.c`. Each handler primarily calls a HAL driver as indicated
by the comments in the source file:

- **`DMA1_Channel1_IRQHandler`** – services DMA channel 1 used by **DAC1 channel 1**.
- **`DMA1_Channel2_IRQHandler`** – services DMA channel 2 used by **DAC1 channel 2**.
- **`DMA1_Channel3_IRQHandler`** – services DMA channel 3 used by **ADC1**.
- **`DMA1_Channel4_IRQHandler`** – services DMA channel 4 used by **ADC2**.
- **`DMA1_Channel5_IRQHandler`** – services DMA channel 5 used by **DAC2 channel 1**.
- **`ADC1_2_IRQHandler`** – shared handler for **ADC1** and **ADC2** conversions.
- **`TIM2_IRQHandler`** – timer interrupt for **TIM2**, driving the main control loop.
- **`TIM3_IRQHandler`** – timer interrupt for **TIM3**, used for timeout tasks.
- **`TIM6_DAC_IRQHandler`** – timer interrupt for **TIM6** plus DAC1/3 underrun handling.
- **`TIM7_DAC_IRQHandler`** – timer interrupt for **TIM7** plus DAC2/4 underrun handling.

## Summary Table

| Handler | Related Peripheral(s) |
|---------|----------------------|
| `NMI_Handler` | Cortex-M4 exception |
| `HardFault_Handler` | Cortex-M4 exception |
| `MemManage_Handler` | Cortex-M4 exception |
| `BusFault_Handler` | Cortex-M4 exception |
| `UsageFault_Handler` | Cortex-M4 exception |
| `SVC_Handler` | Cortex-M4 exception |
| `DebugMon_Handler` | Cortex-M4 exception |
| `PendSV_Handler` | Cortex-M4 exception |
| `SysTick_Handler` | System tick timer |
| `DMA1_Channel1_IRQHandler` | DAC1 channel 1 DMA |
| `DMA1_Channel2_IRQHandler` | DAC1 channel 2 DMA |
| `DMA1_Channel3_IRQHandler` | ADC1 DMA |
| `DMA1_Channel4_IRQHandler` | ADC2 DMA |
| `DMA1_Channel5_IRQHandler` | DAC2 channel 1 DMA |
| `ADC1_2_IRQHandler` | ADC1 and ADC2 |
| `TIM2_IRQHandler` | TIM2 timer |
| `TIM3_IRQHandler` | TIM3 timer |
| `TIM6_DAC_IRQHandler` | TIM6 and DAC1/DAC3 |
| `TIM7_DAC_IRQHandler` | TIM7 and DAC2/DAC4 |

## DAB Application Interrupts

The DAB control algorithm relies on four timer interrupts to run its tasks.
Each timer is configured in `DPC_Application.c` using
`DPC_MISC_APPL_Timer_Init()` and then enabled with
`DPC_MISC_Appl_Timer_Start()`.
`HAL_TIM_Base_Start_IT` causes an **update interrupt** whenever the
counter reaches the auto-reload value programmed during initialization.
The desired frequencies for these update events come from
`DPC_Application_Conf.h`:

| Timer (IRQ) | Macro | Frequency | Period | Purpose |
|-------------|-------|----------:|-------:|---------|
| **TIM2_IRQHandler** | `RefreshTime_DESIDERED` | 10&nbsp;kHz | 100&nbsp;µs | High-frequency control: ADC DMA readout and state-machine update. |
| **TIM3_IRQHandler** | `RefreshTime_TO_DESIDERED` | 1&nbsp;kHz | 1&nbsp;ms | Timeout and supervision tasks. |
| **TIM6_DAC_IRQHandler** | `RefreshTime2_DESIDERED` | 3&nbsp;kHz | ≈333&nbsp;µs | Increment voltage/current ramps. |
| **TIM7_DAC_IRQHandler** | `RefreshTime3_DESIDERED` | 2&nbsp;kHz | 500&nbsp;µs | User monitoring and optional debug DAC. |

The callback implementing these tasks resides in `DPC_DAB/App/DPC_Application.c`. Inside `HAL_TIM_PeriodElapsedCallback` the code checks `htim->Instance` to select the appropriate action.

### Callback Implementation

`HAL_TIM_PeriodElapsedCallback` is defined starting around line 400 of
`DPC_DAB/App/DPC_Application.c`.  The function branches on each timer
instance to dispatch control tasks (see the source file for the full
state‑machine logic).

## Timer ISR Definitions

The actual interrupt service routines for the four timers are implemented in
`Core/Src/stm32g4xx_it.c`. Each handler invokes `HAL_TIM_IRQHandler` for its
associated timer, which in turn triggers the callback above. The functions are:

| Timer | ISR Name |
|-------|----------|
| TIM2  | `TIM2_IRQHandler` |
| TIM3  | `TIM3_IRQHandler` |
| TIM6  | `TIM6_DAC_IRQHandler` |
| TIM7  | `TIM7_DAC_IRQHandler` |

